name: Deploy Frontend to OpenShift

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install oc CLI
        uses: redhat-actions/oc-installer@v1
        with:
          version: "4.12"

      - name: Login to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: white-hat-project
          insecure_skip_tls_verify: true

      - name: Start build in OpenShift
        run: |
          set -euxo pipefail

          oc project white-hat-project

          oc start-build frontend --follow --wait

      - name: Verify deployment
        run: |
          set -euxo pipefail

          oc rollout restart deployment/frontend

          oc rollout status deployment/frontend -w --timeout=5m

          oc get pods -l app=frontend
          oc get route frontend
