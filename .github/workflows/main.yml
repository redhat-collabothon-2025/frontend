name: Deploy Frontend to OpenShift

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        env:
          CI: false
          VITE_API_URL: https://backend-white-hat-project.apps.cluster-xdhbp.xdhbp.sandbox1403.opentlc.com
        run: npm run build
      
      - name: Install oc CLI
        uses: redhat-actions/oc-installer@v1
        with:
          version: '4.12'
      
      - name: Login to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: white-hat-project
          insecure_skip_tls_verify: true
      
      - name: Deploy to OpenShift
        run: |
          # Создаём ConfigMap с собранными файлами
          oc create configmap frontend-build --from-file=dist/ --dry-run=client -o yaml | oc apply -f -
          
          # Если используешь Deployment вместо BuildConfig:
          oc rollout restart deployment/frontend || echo "Deployment not found"
          oc rollout status deployment/frontend -w --timeout=5m || echo "Waiting for deployment"
      
      - name: Verify Deployment
        run: |
          oc get pods -l app=frontend
          oc get route frontend